#cloud-config
# Generated by Ansible Dev Environment project
# Assisted by Cline (powered by xAI Grok model) on 2025-09-25.

users:
  - name: {{ target_user }}
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/zsh
    groups: sudo, wheel, docker
    home: /home/{{ target_user }}
    create: true

packages:
  - curl
  - git
  - python3
  - python3-pip
  - ansible
  - zsh
  - tmux
  - docker-ce
  - containerd.io
  - docker-compose-plugin
  - netdata
{% if ansible_os_family == 'Debian' %}
  - nala
{% elif ansible_os_family == 'RedHat' %}
  - dnf-automatic
{% endif %}
{% for app in basic_apps %}
  - {{ app }}
{% endfor %}

write_files:
  - path: /tmp/setup.sh
    content: |
      #!/bin/bash
      cd /tmp
      git clone {{ playbook_repo_url | default('https://github.com/youruser/ansible-dev-env.git') }} ansible-dev-env
      cd ansible-dev-env
      ansible-galaxy collection install -r requirements.yml
      # Install Nix
      sh <(curl -L https://nixos.org/nix/install) --daemon
      # Install Netdata if not in playbook
      bash <(curl -Ss https://get.netdata.cloud/kickstart.sh) --dont-wait --disable-telemetry
      # Run playbook with tags excluding cloud-init to avoid loop
      ansible-playbook -i localhost, site.yml --connection=local --extra-vars "target_user={{ target_user }}" --skip-tags cloud-init

runcmd:
  - chmod +x /tmp/setup.sh
  - /tmp/setup.sh
  - rm -rf /tmp/setup.sh

# Note: Set playbook_repo_url in vars for your Git repo.
